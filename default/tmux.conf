# Prefix key, vi mode #{{{1
set-option -g prefix C-a
unbind-key C-b
bind-key -n C-1 send-prefix
bind-key C-a send-prefix
bind-key a send-prefix

# vi mode
set-option -g mode-keys vi

# Allow the arrow key to be used immediately after changing windows
set-option -g repeat-time 0

# Fix escape key delay
set -sg escape-time 0

# Window base options #{{{1

# Window Numbering #{{{2
set-option -g base-index 1
set-option -g pane-base-index 1
set-option -g renumber-windows on

# Keep detached sessions alive #{{{2
set-option -g destroy-unattached off
set-option -g exit-unattached off
set-option -g detach-on-destroy on

# dynamic window title
set-option -g set-titles on
# set-option -g set-titles-string '#P' # window number,program name,active (or not)
set-window-option -g automatic-rename on # auto name
set-window-option -g allow-rename off # Don't let escape sequences rename window

# Set window notifications
set-option -g visual-activity off   # statusline notification

# config reload
bind-key R display-message "reloading config" \; source-file ~/.tmux.conf
bind-key r refresh-client

# scrollback buffer n lines
set-option -g history-limit 8192

# listen for activity on all windows
set-option -g bell-action any
set-option -g visual-bell off
if-shell "[[ \"$(tmux -V | sed -e 's/.*\([0-9]\)\.\([0-9]\).*/\1\2/g')\" -lt 26 ]]" \
  "set-option -g bell-on-alert on\;"

set-window-option -g xterm-keys off
set-option -g default-terminal "screen-256color"
if-shell "printenv ITERM_SESSION_ID >/dev/null 2>/dev/null" \
  "set-window-option -g aggressive-resize on\;"

set-window-option -g other-pane-height 25
set-window-option -g other-pane-width 80

set-window-option -g display-panes-time 1500

# environment
set-option -g update-environment "DISPLAY SSH_ASKPASS SUDO_ASKPASS SSH_AUTH_SOCK SSH_AGENT_PID  SSH_CONNECTION WINDOWID XAUTHORITY"

# MOUSE {{{1
# I don't use mode mode any more...
#if-shell "echo $(tmux -V | cut -f2 -d ' ') | awk '{exit !( $1 >= 2.1)}'"\
# 'set-option -g mouse on' 'set-option -g mode-mouse on\; set-option -g mouse-select-pane on\; set-option -g mouse-resize-pane on\; set -g mouse-select-window on'

# KEYS: Panes and Window  {{{1

bind-key @ confirm-before kill-session
bind-key e set-option synchronize-panes
bind-key n next-window
bind-key m previous-window
bind-key C-o rotate-window
bind-key BSpace clearhist

# use vim-like keys for splits and windows
bind-key v split-window -h -c "#{pane_current_path}"
bind-key s split-window -v -c "#{pane_current_path}"
bind-key c new-window -c "#{pane_current_path}"
bind-key C new-window
bind-key l select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key h select-pane -R
unbind-key %
unbind-key -n %

# smart pane switching with awareness of vim splits
unbind-key C-l
unbind-key -n C-l
bind-key C-l send-keys 'C-l' # allows prefix C-l for redraw
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -nr C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind -nr C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind -nr C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind -nr C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
bind -nr C-\ if-shell "$is_vim" "send-keys C-w\\" "select-pane -l"
bind \ last-pane
bind b last-window

# KEYS: Copy / Paste# {{{2
bind-key [ copy-mode
bind-key Escape copy-mode
unbind-key ]

bind-key '~' split-window -v -p 50 "htop -C || top"


# sed: bash 3 only plays with integers
# when subshell output===24, `[` seems to fail? but `[[` works?? (WHY: `[[` is not posix)
if-shell "[[ \"$(tmux -V | sed -e 's/.*\([0-9]\)\.\([0-9]\).*/\1\2/g')\" -lt 24 ]]" \
  " bind-key -t vi-copy v     begin-selection \;  \
    bind-key -t vi-copy V     rectangle-toggle \; \
    bind-key -t vi-copy y     copy-pipe          \"xsel -ib || reattach-to-user-namespace pbcopy\" \; \
    bind-key -t vi-copy Enter copy-pipe          \"xsel -ib || reattach pbcopy\" \; \
  " "\
    bind-key -T copy-mode-vi 'v'   send-keys -X begin-selection\;    \
    bind-key -T copy-mode-vi 'V'   send-keys -X rectangle-toggle\;   \
    bind-key -T copy-mode-vi 'y'   send-keys -X copy-pipe-and-cancel \"xsel -ib || reattach-to-user-namespace pbcopy\"\; \
    bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel \"xsel -ib || reattach-to-user-namespace pbcopy\"\; \
  "

bind-key p run "(xsel -bo || reattach-to-user-namespace pbpaste || echo 'what is an xsel') | tmux load-buffer - && tmux paste-buffer"


# PRETTY: Colours  {{{1
set-option -g status-style                 "fg=colour244,bg=default,none"
set-option -g window-status-last-style     "fg=colour244,bg=default"
set-option -g window-status-activity-style "fg=colour244,bg=default"
set-option -g window-status-current-style  "fg=colour255,bg=colour235"
set-option -g window-status-format         "#I:#W#[none]"
set-option -g window-status-current-format "#I:#W#[none]"
set-option -g window-status-separator      " "

set-option -g window-status-bell-style     "fg=colour254,bg=colour160"

set-option -g pane-border-style            "fg=colour238,none"
set-option -g pane-active-border-style     "fg=colour234,bg=0"

set-option -g message-style                "fg=colour196,bg=colour235"

set-option -g display-panes-active-colour colour20  #blue
set-option -g display-panes-colour        colour196 #orange

set-window-option -g clock-mode-colour colour40 #greeen

# PRETTY: Status Bar# {{{1
set-option -g status-interval 1
set-option -g status-right-length 40
set-option -g status-left-length 40
set-option -g status-justify left
set-option -g status-left '#[fg=colour33,bright]#{session_name} #[fg=colour244,none] #[default]'
set-option -g status-right ''

if-shell '[ -n "$SSH_CONNECTION" ]' 'set-option -g status-left "#[default]#[fg=colour104]#(whoami)#[fg=colour237]@#[fg=colour166]#[bold]#{host}#[fg=colour244,none]:#[default]#[fg=colour33,bright]#{=3:session_name} #[fg=colour244,none] â€¢ #[default]"'

# DEACTIVATED: IDEAS {{{1

# initialize sessions
#bind-key S source-file ~/.config/tmux/standard
#bind-key I source-file ~/.config/tmux/irssi
# Config file if in X or not
# if-shell '[ -n "$DISPLAY" ]' 'source-file ~/.config/tmux/inx' 'source-file ~/.config/tmux/xless'

# on-screen time for display-panes in ms
#set-option -g display-panes-time 2000
