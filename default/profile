# vi: ft=sh sts=2 sw=2 et

export PATH
adjunct_path_with () {
  adjunctor="$1" # the directory  ## WARN: DO NOT USE TRAILING SLASH OR THE WORLD ENDS!
  override="$2"  # if $2 is true: $1 is prefixed to PATH; else $1 is appended to PATH

  if ! [ -d "$adjunctor" ]; then
    return 1
  fi

  if [ "$override" = "true" ]; then
    PATH="$1:$PATH"
  elif [ "${PATH#*$adjunctor}" != "$PATH"  ]; then
    return 0
  else
    PATH="$PATH:$1"
  fi
}

has () {
  if command -V $1 2>/dev/null >&2; then
    return 0
  fi
  return 1
}

adjunct_path_with "/sbin"              true
adjunct_path_with "/usr/sbin"          true
adjunct_path_with "/usr/local/sbin"    true
adjunct_path_with "/usr/local/bin"     true
adjunct_path_with "${HOME}/bin"        false
adjunct_path_with "${HOME}/.cargo/bin" false
adjunct_path_with "${HOME}/Go/bin" false
adjunct_path_with "${HOME}/.local/bin" false


export EDITOR VISUAL
if has nvim; then
  EDITOR=nvim
elif has vim; then
  EDITOR=vim
elif has vi; then
  EDITOR=vi
elif has ed; then
  EDITOR=ed
fi

VISUAL="$EDITOR"

export MOSH_ESCAPE_KEY='~'
export VIRTUAL_ENV_DISABLE_PROMPT=1

[ -n "$XDG_CONFIG_HOME" ] || export XDG_CONFIG_HOME="$HOME/.config"
[ -n "$XDG_CACHE_HOME"  ] || export XDG_CACHE_HOME="$HOME/.cache"
[ -n "$XDG_DATA_HOME"   ] || export XDG_DATA_HOME="$HOME/.local/share"

if has go; then
  export GOPATH="${HOME}/Go"
fi


#{{{1 Less
# Mouse-wheel scroll can be disabled by -X (disable screen clearing)
# Remove -X and -F (exit if the content fits on one screen) to enable mouse-wheel scroll
if [ -z "$LESS" ]; then
  export LESS="--no-init --quit-if-one-screen --quit-on-intr --force --dumb --ignore-case --no-lessopen --RAW-CONTROL-CHARS --tilde --shift 8 --chop-long-lines"
  export LESSSECURE='1' LESSHISTFILE='-' LESSCHARSET='utf-8'
fi

#{{{1 Pretty colours
export GREP_COLOR="1;33"
export LESS_TERMCAP_mb=$'\e[01;31m' LESS_TERMCAP_md=$'\e[01;34m' LESS_TERMCAP_me=$'\e[0m' LESS_TERMCAP_se=$'\e[0m' LESS_TERMCAP_so=$'\e[01;30;03;36m' LESS_TERMCAP_ue=$'\e[0m' LESS_TERMCAP_us=$'\e[01;35m'

#{{{1 fzf
if [ -x ~/.fzf/bin/fzf ]; then
  adjunct_path_with "${HOME}/.fzf/bin" false
  [ -d ~/.fzf/man ] && export MANPATH="$MANPATH:~/.fzf/man"

  # Disabled: use agignore; allows using rg or ag by default code
  # export FZF_DEFAULT_COMMAND='ag -g ""'             # This uses agignore and gitignore
  # export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi

#{{{1 OS Specific
case "$OSTYPE" in
  darwin*)
    if [ "$(id -u)" -eq 0 ]; then
      # Add localbins  to path, esp for homebrew
      adjunct_path_with "/usr/local/sbin" true
    fi
    adjunct_path_with /usr/local/opt/coreutils/libexec/gnubin true
    export CLICOLOR=1
    export LSCOLORS=ExFxCxDxBxegedabagacad
    export BROWSER='open' # Use the open command on OSX

    # fuck macOS, honestly
    alias vi='reattach-to-user-namespace vim'
    alias vim='reattach-to-user-namespace vim'
    alias nvim='reattach-to-user-namespace nvim'

    # ignore some things in completions
    # http://sigpipe.macromates.com/2012/08/10/path-completion-bash
    FIGNORE="$FIGNORE:.o:~:Application Scripts"

    case "$SHELL" in
      *bash)
	if [ -f `brew --prefix`/etc/bash_completion ]; then
	  . `brew --prefix`/etc/bash_completion
	fi
	;;
    esac
    ;;
  linux*)
    [ -n "$PAGER"   ] || export PAGER='/usr/bin/less' SYSTEMD_PAGER='/usr/bin/less'
    [ -n "$SYSTEMD_LESS"    ] || export SYSTEMD_LESS="${LESS}"
    export BROWSER
    for THIS in brave firefox firefox-esr chromium x-www-browser; do
      has $THIS && BROWSER=$THIS && break
    done
    ;;
  *) return ;;
esac


#{{{1 Guard for non-interactive shells
case "$-" in
  *i*)  ;;
  *)   return ;;
esac

#{{{1 Disable flow control
stty -ixon

#{{{1 TMOUT
if [ "$(id -u)" -eq 0 ]; then
  export TMOUT=300
else
  export TMOUT=0
fi

#{{{1 Bash history
export HISTSIZE=65536 HISTFILESIZE=1048576
export HISTIGNORE='&:[ ]*:exit'
export HISTCONTROL='ignoreboth'  #ignore dups and space

# for the benefit of tmux that is not -i
. ~/.bashrc
